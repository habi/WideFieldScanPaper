%!TEX root = widefieldscan.tex
\svnidlong
{$HeadURL$}
{$LastChangedDate$}
{$LastChangedRevision$}
{$LastChangedBy$}

\ifhtml
\else
\begin{center}
	\fbox{
		\begin{minipage}{.618\columnwidth}
		The section below is versioned at \url{\svnkw{HeadURL}} (last commit @ \svnfileday.\svnfilemonth.\svnfileyear \space \svnfilehour:\svnfileminute, Revision: \svnkw{LastChangedRevision}).
		\end{minipage}
	} 
\end{center}
\fi

\section{Materials and Methods}
\label{sec:materials and methods}
\cbstart
\subsection{Sample Preparation and Image Acquisition}
To test the enhancement of the FOV of the tomographic microscopy, we used rat lung samples, prepared according to~\citet{Schittny1997,Schittny1998}\todo{citations (taken from Schittny2008) still valid for our protocol?}. Briefly, lungs of Sprague-Dawley rats have been extracted after they have been perfused and filled with phosphate buffered saline by instillation via tracheotomy until the mid respiratory lung volume was reached. Handling of the animals before and during the experiments, as well as the experiments themselves, were approved and supervised by the Swiss Agency for the Environment, Forests and Landscape and the Veterinary Service of the Canton of Bern.

The extracted lung lobes have been fixed in \SI{2.5}{\percent} glutaraldehyde (C$_5$H$_8$O$_2$). For the preparation of the imaging the samples have been postfixed---comparable to electron microscopy protocols---with \SI{1}{\percent} osmium tetroxide (OsO$_4$) and stained with \SI{4}{\percent} uranyl acetate (C$_4$H$_6$O$_6$U), dehydrated in a graded series of ethanol and transferred into paraffin. The lung samples have been mounted onto standard electron microscopy sample mounts with a diameter of approximately \SI{13}{\milli\meter} (PLANO GmbH, Wetzlar, Germany) using paraffin.
\cbend

\subsection{SRXTM}
All experiments were performed at the TOMCAT beamline, Swiss Light Source, Paul Scherrer Institut, Villigen, Switzerland. %; , which is located at the X02DA port of the SLS and is one of 17 currently operating beamlines.
TOMCAT receives photons from a \SI{2.9}{\tesla} super-bending magnet. The critical energy of this super-bending magnet is \SI{11.1}{\kilo\electronvolt} (corresponding to a wavelength of \SI{1.22}{\angstrom}). A double crystal multilayer monochromator covers an energy range between 6 and \SI{45}{\kilo\electronvolt} with a bandwidth range of a few percent to a few per mille. Detailed technical specifications of the beamline and beam characteristics have been described by~\citet{Stampanoni2006a,Stampanoni2007}.

\subsubsection{Image acquisition and reconstruction}
\label{seq:Image Acquisition}
The sample holder at TOMCAT is equipped with an appropriate collet chuck to mount standard electron microscopy (EM) sample tables into the beam. The samples have been scanned at an x-ray energy of \SI{12.6}{\kilo\electronvolt}. After penetration of the sample, the x-rays are converted into visible light by a YAG:Ce scintillator (\SI{18}{\micro\meter} thickness, Crismatec Saint-Gobain, Nemours, France). The projection images were further magnified by diffraction limited microscope optics and digitized by a high-resolution 2048\(\times\)2048 pixel CCD camera (pco.2000, PCO AG, Kelheim, Germany) with 14 bit dynamic range.% which can record projections into the internal memory of \SI{4}{\giga\byte}.
The lung samples were imaged using a 10\(\times\) magnification, with 2\(\times\)2 binning and \SI{175}{\milli\second} exposure time resulting in isotropic voxels with a side length of \SI{1.48}{\micro\meter}\todo{for B--T, and also for Sophies Sample shown for the 5-subscan-case}.

\cbstart
Projection images $I_{Pr}$---essentially single radiographies---of the samples have been recorded at several angular positions between \SI{0}{\degree} and \SI{180}{\degree}. The amount of projections obtained varied for each protocol, an exact description follows below. Additionally, a set of dark ($I_{D}$) and flat images ($I_{F}$) are recorded for each protocol. The dark image set was obtained with a closed shutter at the start of the scan, it captured the camera noise and dark current and was used to baseline correct the projection images. The flat image set has been recorded at the start and at the end of the scan, it captures the beam profile and was used to normalize the projection images.

Corrected projection images $I_{cPr}$ have been obtained by correcting $I_{Pr}$ with the average dark ($\overline{I_{D}}$) and average flat image ($\overline{I_{F}}$) using the Beer-Lambert law in Equation~\ref{eq:beer-lambert} and relation described in equation~\ref{eq:cpr}.

The Beer--Lambert law relates the absorption of electromagnetic waves to the properties of the material through which these waves are traveling. Let $I_{0}$ and $I_{1}$ be the intensity of the incident electromagnetic wave and the intensity after penetration of the material, respectively. If $\alpha$ describes the absorption coefficient of the substance and $l$ the path length the wave travels through the material, then the intensity of the transmitted wave can be calculated as follows:
\begin{equation}
	I_{1}=I_{0}e^{-\alpha l}
\label{eq:beer-lambert}
\end{equation}

The inversion of the beer lambert was used to calculate the corrected projection images $I_{cPr}$:
\begin{equation}
	I_{cPr} = -ln\left(\frac{I_{Pr}-\overline{I_{D}}}{\overline{I_{F}}-\overline{I_{D}}}\right)
	= ln(\overline{I_{F}}-\overline{I_{D}})-ln(I_{Pr}-\overline{I_{D}})
	\label{eq:cpr}
\end{equation}
\cbend

The full work flow from image acquisition to tomographic dataset on the disk contains several steps more, detailed explanations are described by~\citet{Hintermueller2009}.

\subsubsection{Covering a broad FOV}
\label{subsec:covering a broad fov}
For parallel beam geometry, tomographic images are obtained by rotating the sample over \SI{180}{\degree} and acquiring images equidistantly between \SI{0}{\degree} and \SI{180}{\degree}, as shown in figure~\ref{subfig:scanning-possibilities}. After reconstruction the width of the image corresponds to the FOV of the camera.

If the sample to be imaged is larger than the available FOV of the camera (up to twice as large as the FOV), a \SI{360}{\degree}-scan is performed. Projections are obtained over a full rotation of the sample, while the sample is positioned in front of the camera in such a way that it only covers half the FOV of the detector. After acquisition of the projection images, half of the dataset has to be flipped and the projections at position $P_{x}$ and $P_{x+\SI{180}{\degree}}$ are stitched together to projection images covering two times the FOV of the camera.

\begin{figure*}
	\noindent\makebox[\textwidth]{%
		\subfloat[Three different scanning configurations for increasing sample diameter.]{%
			\input{tikz-images/scanning-possibilities}%
			\label{subfig:scanning-possibilities}%
		}%
		\subfloat[Stacked scanning for long and thin samples.]{%
			\input{tikz-images/Scan-Stacked}%
			\label{subfig:stacked-scan}%
		}%
	}% end of \makebox
	\caption[Covering the FOV of differently sized samples]{\subref{subfig:scanning-possibilities}: Covering the FOV of differently sized samples with one \SI{180}{\degree} scan (top), one \SI{360}{\degree} scan (center) or---in the case of the so called wide field scanning---with multiple subscans (three subscans, bottom) The filled red, green and blue segments mark the region of the sample which is covered while scanning the respective positions. \subref{subfig:stacked-scan}: Increasing the vertical FOV with stacked scanning.
	}%
	\label{fig:scanning-possibilities}%
\end{figure*}

If we want to achieve tomographic scans covering a sample size which is bigger than what can be achieved with a \SI{360}{\degree}-scan, we have to move the sample in relation to the beam and camera while performing several partial scans. This can be done as shown in figure~\ref{subfig:scanning-possibilities}, where we obtain three subscans to be able to reconstruct a sample as big as three FOVs.

\cbstart
While covering the desired FOV, the projection images of each subscan have to overlap each other slightly to allow for an optimal stitching of the multiple projections into one big projection. Preliminary experiments have shown that an overlap of approximately 20 pixels allows for the calculation of the cutting line between the independent subscans with a precision of one pixel. Using the mean squared difference between adjacent subscan images~\citet{Hintermueller2009}, such a cutline has been calculated for all the adjacent subscans of every scanned protocol and used to merge the single projections into projections covering the full FOV.
\cbend

%The cutting line for the three subscans has been calculated using the mean squared difference between adjacent subscan images~\citet{Hintermueller2009}. Briefly, for each displacement $\xi_{i,j}$ of the images $i$ and $j$ the mean squared difference of the displacement $\delta^2(\xi_{i,j})$ is computed. This quantity measure provides a measure for the inequality of the two images within their overlapping parts. The local minimum of $\delta^2(\xi_{i,j})$ shows the effective displacement $\xi_{i,j}$ between the two adjacent images $i$ and $j$. For three subscans we calculate the effective displacement $\xi_{1,2}$ and $\xi_{2,3}$ and stitch all the images into one big projection image.

\subsection{Wide Field Scanning}
\cbstart
A custom MATLAB-script (MATLAB\textsuperscript{\textregistered} 7.6.0.321 (R2008a), The MathWorks, Inc.) has been written to enable the user to input the scanning parameters like desired FOV, detector width, desired overlap between the subscans, magnification and binning. According to these presets, the scripts calculated the necessary projections to fulfill the sampling theorem for the chosen FOV as a gold-standard and computes different acquisition protocols with reduced amount of projections. For all these scanning protocols a reconstruction is simulated using a Shepp-Logan phantom~\cite{Shepp1974} and we calculate the expected reconstruction quality using the difference image for each simulated reconstruction with the gold standard (the original phantom). This expected reconstruction quality is then plotted against the acquisition time, such a plot is shown in figure~\ref{fig:2008c-qualityplot}.

After the user has chosen a suitable protocol which balances the requirements for reconstruction quality and need for fast acquisition time (corresponding to one dot in figure~\ref{fig:2008c-qualityplot}), a preference file is written. This preference file contains the details of the selected scan like amount of needed subscans and the positions of the sample, number of projections as well as start and stop angles of the rotation for each subscan. Subsequently, the preference file is parsed by a custom Python-script to interact with the EPICS-System (Experimental Physics and Industrial Control System, Argonne National Laboratory, Argonne, USA, \url{http://www.aps.anl.gov/epics/}), which itself is used to control the hardware of the TOMCAT beamline, allowing for an unattended batch scan of all the desired subscans.
\cbend

\begin{figure*}
	\centering
	\input{tikz-images/plots/2008c-QualityPlot}%
	\caption[Quality-Plot of 34 calculated protocols]{Quality-Plot of 34 calculated protocols. The red dots show the expected quality of the different protocols, the black plot is a polynomial fit $p(x)$ with $n=4$ for $p(x)=p_{1}x^{n}+p_{2}x^{n-1}+\cdots+p_{n}x+p_{n+1}$. A subset of 19 protocols have been scanned. Details of these scans are shown in table~\ref{tab:projections} and are discussed in section~\ref{sec:Results}.}%
	\label{fig:2008c-qualityplot}%
\end{figure*}

\hrule
studding not only one, but all protocols to assess the quality -> tüdeldü!

EXPLAIN WHY WE HAVE THE DIFFERENT PROTOCOLS -> THIS LEADS TO THE NEED FOR INTERPOLATION, SO THE FIGURES CAN BE SHOWN HERE. DISCUSS THE DETAILS OF THE PROTOCOLS, THE DIVISION BY TWO FOR THE nUMpROJ AND THE TWO DRAWINGS.

\cbstart
To fulfill the sampling theorem as defined in section~\ref{subsec:enhancing the field of view}, a $N_{i}$ projections have been recorded for each subscan $i$. A simple example with $N_{1}=4$ and $N_{2}=N_{3}=8$ is shown in figure~\ref{fig:projections}. If we assume that we only need to acquire four projections for the central part of the sample to satisfy the sampling theorem, we need to acquire 16 projections for the lateral parts of the sample to be able to fulfill the sampling theorem\todo{Is there some ``formula'' we can cite instead of just saying it?}.

Since we generally acquire different amounts of projections for the central and the lateral parts of the sample our stitching algorithm has to selectively stitch projections from the single subscans to one projection covering the combined FOV. The missing projections which have not been acquired for the central scan need to be interpolated from the adjacent projections to be able to obtain the necessary amount of merged projections to be able to reconstruct the sample while fulfilling the sampling theorem.

This need for interpolation depending on the acquired amount of projections led to a simple strategy for designing the different protocols.  has been defined; to facilitate the merging of the projections from each subscan, the amount of projections from the inner to the outer subscans $\frac{P_{outer}}{P_{inner}} \bmod 2 = 0$ is always a multiple of two.

This approach facilitates the merging of the different subscans in such a way that we can stitch several projections from the inner subscan with projections from the outer subscan as shown in figure~\ref{fig:amount of projections}. Equation~\ref{eq:Modulo} ensures that the stitching and---where applicable---interpolation of projections can be done in an efficient way. 
\cbend

\cbstart
\begin{figure*}
	\centering
%	\includegraphics[width=\imsize]{img/projections}
	\subfloat[]{%
		\input{tikz-images/ProjectionSetup}%
		\label{subfig:ProjectionSetup}%
		}%
	\hfill%
	\subfloat[]{%
		\input{tikz-images/ProjectionSetupInterpolate}%
		\label{subfig:ProjectionSetupInterpolate}%
		}%
	\caption{Setup with one central (green) and two lateral scans (red and blue, respectively). For demonstration purposes, the central scan has four projections and the lateral scans have eight projections each (all acquired over \SI{180}{\degree}. The colors of the three positions correspond to the colors shown in figure~\ref{subfig:scanning-possibilities}. \subref{subfig:ProjectionSetup}: scanned projections, \subref{subfig:ProjectionSetupInterpolate}: scanned projections and additional interpolated projections (dashed) needed to correctly merge all projections.}
	\label{fig:projections}
\end{figure*}
\cbend

Figure \ref{fig:amount of projections} shows how the projections from the different subscans relate to each other in the more complex case. In this case we would acquire 1500 projections for the central and two times 3000 projections for the two ring-scans to fully satisfy the sampling theorem. 

\begin{figure*}
	\centering
	\input{tikz-images/amountofprojections}%
	\caption[Number of merged projections for one central- and two ring-scan.]{Number of merged projections for one central- and two ring-scan. We assume that we have obtained 1500 projections for the central scan and thus acquire two times 1500 projections for each of the lateral scans. This enables us to stitch the projections $P_{1_{284}}$ % XXX XXX 17*3000/180 XXX
 		(red line) from subscan 1 (ring scan, red area), projection $P_{2_{142}}$ % XXX 17*1500/180 XXX
 		(green line) from subscan 2 (central scan, green area) and projection $P_{3_{283}}$ % XXX 17*3000/180 XXX
 		(blue line) of subscan 3 (ring scan, blue area) to one big projection $P_{merge_{284}}$ % XXX 17*3000/180 XXX
		which covers the full FOV. The areas of the three subscans overlap slightly as described above to account for variations in positioning. For illustration purposes we shifted the central projection (green) by \SI{2}{\degree}, otherwise the overlap between these particular projection would not be visible.}%
	\label{fig:amount of projections}%
\end{figure*}

\hrule
\subsubsection{Reduction of the acquisition time}
The proposed protocols are designed in such a way that the total scanning time---which scales with the total amount of recorded projections---can be arbitrarly reduced compared to a gold standard scan.

\cbstart
Such a gold standard scan would fully cover the desired FOV while fulfilling the sampling theorem, as shown in figure~\ref{subfig:fovneed}. For this example we would like to achieve a FOV of 3072$\times$3072 pixels. The dark grey circle shown in aforementioned figure is the FOV that can be fully covered, the rest of the slice in light grey would be either missing or show artifacts arising from partial volume effects, depending on the chosen reconstruction algorithm. To cover this desired FOV without a standard scan obtained from a detector with the size of 1024 pixels, nine independet scans would be needed. Acquiring nine independent scans would show exactly the same ration of coverage vs.\ potentially missing parts, but some of the missing parts would be lying inside the desired FOV, which can be seen in the light grey parts figure~\ref{subfig:goldstandard} inside the ring covering the desired FOV. Nonetheless, this is the gold standard, we defined as standard protocol A shown in table~\ref{tab:projections}. Figure~\ref{subfig:protocolb} shows how the desired FOV can be covered with a wide-field scan obtained from merged projections as described above. No missing parts arising from partial volume effects are lying inside the desired FOV.

To fully satisfy the sampling theorem for a scan with the detector width $D$ we need to aquire an amount of projections $P=D\frac{\pi}{2}$, which leads to the acquisition of totally 14476 projections for the setup shown in figure~\ref{subfig:goldstandard}. For figure~\ref{subfig:protocolb} we need to aquire the same amount since we need to acquire three times $3072\frac{\pi}{2}$ projections if the single projections from each subscan are to be merged into one projections covering the FOV prior to reconstruction.
\cbend

\cbstart
\begin{figure*}
	\centering
	\input{tikz-images/GoldStandardVsProtocolB}
	\caption{Theoretical setup; desired FOV and two variants of covering the desired FOV.}
	\label{fig:goldstandard}
\end{figure*}
\cbend

\cbstart
Table~\ref{tab:projections} provides the numbers for real-world examples that have been scanned, except protocol A. Protocol A would corresponds to the figure~\ref{subfig:goldstandard}, which would require nine independent reconstructions and stitching of the resulting small reconstructions into one big slice. As shown above, we can equally satisfy the sampling theorem when enough projections are acquired for a simulated detector size that is three times the real detector size of 1024 pixels. Including an overlap of 100 pixels between the central and the ring scan, we would need to acquire $N_{B}=15419$ projections for protocol B ($N_{B}=3(3072+200)\frac{\pi}{2}$). All the other protocols from C--T have been linearly scaled down with a decreasing percentage of acquired projections of the gold standard. The difference of total amount of projections resulting from this scaling to the amount of projections shown in the table arises through the fact that the amount of projections for each subscan has been chosen in such a way, that equation~\ref{eq:Modulo} is satisfied for all protocols, whic facilitates the stitching of the projections, hence the small differences in total amount of scanned to total amount of calculated projections.

We were able to reduce the total acquisition time by \SI{86.25}{\percent} compared to the gold standard, as can be seen in table~\ref{tab:projections}. All 19 protocols have been scanned, reconstructed and visualized three-dimensionally to assess the artifacts which arise through the reduction of the amount of projections. Albeit the maximally assessed reduction in scanning time by \SI{86.25}{\percent} does introduce visible artifacts in the three-dimensional reconstruction, an automated segmentation of the airways is still possible, as is shown in section~\ref{subsec:comparison}.
\cbend

%\begin{table*}
%	\centering
%	\caption{Specification of different protocols and time used compared to gold standard}
%	\begin{tabular*}{\textwidth}{l@{\extracolsep\fill}ccccccccccccccccccc}
%		\toprule
%		Protocol 			& B & C & D & E & F & G & H\\
%		\midrule
%		Total Projections 	& 15732 & 13110 & 13110 & 10925 & 11799 & 9833 & 10488\\
%		Time [\%] 			& 100 & 83.33 & 83.33 & 69.44 & 75 & 62.5 & 66.67\\
%		\bottomrule
%	\end{tabular*}
%	\begin{tabular*}{\textwidth}{l@{\extracolsep\fill}ccccccccccccccccccc}
%		\toprule
%		Protocol 			& I & J & K & L & M & N \\
%		\midrule
%		Total Projections 	& 5436 & 8740 & 9177 & 7648 & 7866 & 6555 \\
%		Time [\%] 			& 34.7 & 55.6 & 58.3 & 48.6 & 50 & 41.7 \\
% 		\bottomrule
%	\end{tabular*}
%	\begin{tabular*}{\textwidth}{l@{\extracolsep\fill}ccccccccccccccccccc}
%		\toprule
%		Protocol 			& O & P & Q & R & S & T \\
%		\midrule
%		Total Projections 	& 6555 & 5244 & 4370 & 3933 & 2622 & 2185 \\
%		Time [\%] 			& 41.7 & 33.3 & 27.8 & 25 & 16.7 & 13.9 \\
%		\bottomrule
%	\end{tabular*}
%	\label{tab:projections}
%\end{table*}

\cbstart
\begin{table}%
	\centering%
	\caption{Specification of different protocols and time used compared to gold standard. Protocol A corresponds to the Gold Standard, and would have been needed to cover the same FOV with 9 independent scans with a detector width of 1024 pixels (plus an overlap of 100 pixels), resulting in a number of projections $N_{A}=9(1024+100)\frac{\pi}{2}=15890$. Protocol B corresponds to the protocol shown in figure~\ref{subfig:protocolb}, resulting in a total number of projextions of $N_{B}=3(3072+200)\frac{\pi}{2}=15419$.}%
	\begin{tabular*}{\textwidth}{r@{\extracolsep\fill}ccccccc}%
		\toprule%
		Protocol & A & B & C & D & E & F & G \\%
		\midrule%
		Total Projections & 15890 & 15732 & 13110 & 13110 & 10925 & 11799 & 9833 \\%
		Time [\%] & 100.00 & 99.00 & 82.50 & 82.50 & 68.75 & 74.25 & 61.88 \\%
		\bottomrule%
	\end{tabular*}\\%
	\ifhtml
		\end{table}%
		\begin{table}%
		\centering%
	\else
	\fi
	\begin{tabular*}{\textwidth}{r@{\extracolsep\fill}ccccccc}%
		\toprule%
		Protocol & H & I & J & K & L & M & N \\%
		\midrule%
		Total Projections & 10488 & 8740 & 9177 & 7648 & 7866 & 6555 & 6555 \\%
		Time [\%] & 66.00 & 55.00 & 57.75 & 48.13 & 49.50 & 41.25 & 41.25 \\%
		\bottomrule%
	\end{tabular*}\\%
	\ifhtml
		\end{table}%
		\begin{table}%
		\centering%
	\else
	\fi
	\begin{tabular*}{\textwidth}{r@{\extracolsep\fill}cccccc}%
		\toprule%
		Protocol & O & P & Q & R & S & T \\%
		\midrule%
		Total Projections & 5463 & 5244 & 4370 & 3933 & 2622 & 2185 \\%
		Time [\%] & 34.38 & 33.00 & 27.50 & 24.75 & 16.50 & 13.75 \\%
		\bottomrule%
	\end{tabular*}%
	\label{tab:projections}%
\end{table}%
\cbend

\cbstart
All subscans of each protocol have been scanned without any user intervention, except input of the sample name at the start of the batch-scan. All parameters such as sample-position in relation to the beam, rotation angles and amount of projections to obtain for the subscans have been set in a preference-file. For all 19 scanned protocols (B--T) the sample on the sample holder has not been touched, so that a direct comparison of the reconstructed slices is possible.

After acquisition of the three subscans per protocol, custom MATLAB functions read the parameters of the single subscans (e.g.\ sample name, amount of subscans, amount of dark and flat images) as well as the desired output-name and -suffix and performs all necessary calculations like loading of the correct projections from each subscan, normalizing, interpolation, cutline detection and correct stitching of the images into wide field projections. Exemplary results can be seen in figure~\ref{fig:subscans} and \ref{fig:merge-proj}.

Using the Radon transformation~\cite{Radon1917}, the corrected and merged projections were transformed into so-called sinograms, where the $n$\textsuperscript{th} is composed of the $n$\textsuperscript{th} line of every corrected projection. One sinogram thus contains as many rows as the amount of obtained corrected projections---the angular steps---and as many columns as the width of the merged projection images, thus covering an increased FOV. Each sinogram corresponds to one slice of the tomographic dataset. The $n$\textsuperscript{th} slice of the tomographic scan was reconstructed from the $n$\textsuperscript{th} sinogram using an FFT-based gridrec~\cite{Dowd1999} algorithm.

The merged projections were reconstructed on a 20-node server farm (five \SI{64}{\bit} Opteron machines with 4 cores and \SI{8}{\giga\byte} RAM each). The reconstructions result in an image stack covering a large sample volume of approximately 3000$\times$3000$\times$1024 pixels, a nine-fold increase from the standard volume of 1024$\times$1024$\times$1024 pixels for one single scan.
\cbend

The reconstructions used for the assessment of the image quality of the 19 different scanned protocols of the same sample show a three-fold (2.93\(\times\)) increase in FOV from 1024\(\times\)1024 pixels to 2996\(\times\)2996 pixels. As a proof of concept, we also scanned and reconstructed a lung sample with 5 subscans, which led to a roughly five-fold (4.74\(\times\)) increase in available FOV from 2048\(\times\)2048 pixels to 9703\(\times\)9703 pixels (see figure~\ref{fig:LungSlabSophie}).